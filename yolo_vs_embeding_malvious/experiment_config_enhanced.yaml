# Enhanced Experiment Configuration with Retail-Trained DOLG and Confidence Ensemble
# Run with: python yolo_vs_embeding_malvious/run_experiments.py --config yolo_vs_embeding_malvious/experiment_config_enhanced.yaml

results_dir: ./experiment_results

# Training configuration (skip training, use existing models)
training:
  dataset_yaml: 'data/grocery_augmented/grocery_augmented.yaml'
  yolov8_base: scripts/yolov8m.pt
  yolov11_base: scripts/yolo11m.pt
  yolov8_pretrained: grocery/runs/yolov8_grocery_baseline_20251114_194239/weights/best.pt
  yolov11_pretrained: grocery/runs/yolo11_grocery_baseline_20251114_1953262/weights/best.pt
  train_yolov8: false  # Skip training, use pretrained
  train_yolov11: false  # Skip training, use pretrained
  force_retrain: false
  use_tuning: false
  epochs: 100
  tuning_epochs: 50
  tuning_iterations: 30
  imgsz: 640
  batch_size: 16
  device: cuda:0
  workers: 8
  use_amp: true
  mlflow_uri: file:./mlruns

# Dataset configuration (legacy, kept for compatibility)
dataset:
  path: "data/grocery_augmented/grocery_augmented.yaml"
  name: "grocery_augmented"

# Milvus configuration
milvus:
  dolg_model_path: dolg_model.pth  # Legacy ImageNet DOLG (for comparison)
  db_name: milvus_retail_enhanced.db
  collection_name: "retail_items"
  embedding_dim: 128
  index_type: "FLAT"
  metric_type: "COSINE"
  max_templates_per_class: 10
  batch_size: 32
  use_amp: true
  auto_setup: true

# Experiment control
experiments:
  run_all: true
  baseline_only: false
  use_milvus: true
  similarity_threshold: 0.20  # Default for retail DOLG experiments
  device: cuda:0
  batch_inference: true

# Advanced settings
advanced:
  use_embedding_cache: true
  embedding_cache_path: embedding_cache_enhanced.pkl
  generate_visualizations: true
  generate_report: true
  iou_threshold: 0.25  # For bbox matching in evaluation (adjusted for dataset quality)
  conf_threshold: 0.25
  pin_memory: true
  persistent_workers: true
  cudnn_benchmark: true
  tf32: true
  enable_mlflow: true
  mlflow_experiment_name: "retail_detection_enhanced"

# Individual experiments list
experiment_list:
  # === BASELINE EXPERIMENTS ===
  
  - name: "YOLOv8_Baseline"
    type: "yolov8"
    model_path: "yolov8m.pt"
    use_milvus: false
    similarity_threshold: 0.5
    
  - name: "YOLOv11_Baseline"
    type: "yolov11"
    model_path: "yolov11m.pt"
    use_milvus: false
    similarity_threshold: 0.5
  
  # === IMAGENET DOLG EXPERIMENTS (Previous Approach) ===
  
  - name: "Milvus_Hybrid_ImageNet_0.15"
    type: "yolov8_hybrid"
    model_path: "yolov8m.pt"
    use_milvus: true
    similarity_threshold: 0.15
    use_retail_embeddings: false
    use_confidence_ensemble: false
    
  # === RETAIL-TRAINED DOLG EXPERIMENTS (New Approach) ===
  
  - name: "Milvus_Hybrid_Retail_0.15"
    type: "yolov8_hybrid"
    model_path: "yolov8m.pt"
    use_milvus: true
    similarity_threshold: 0.15
    use_retail_embeddings: true
    retail_model_path: "dolg_retail_model/dolg_retail_best.pth"
    embedding_extractor_type: "retail"
    use_confidence_ensemble: false
  
  - name: "Milvus_Hybrid_Retail_0.20"
    type: "yolov8_hybrid"
    model_path: "yolov8m.pt"
    use_milvus: true
    similarity_threshold: 0.20
    use_retail_embeddings: true
    retail_model_path: "dolg_retail_model/dolg_retail_best.pth"
    embedding_extractor_type: "retail"
    use_confidence_ensemble: false
  
  - name: "Milvus_Hybrid_Retail_0.25"
    type: "yolov8_hybrid"
    model_path: "yolov8m.pt"
    use_milvus: true
    similarity_threshold: 0.25
    use_retail_embeddings: true
    retail_model_path: "dolg_retail_model/dolg_retail_best.pth"
    embedding_extractor_type: "retail"
    use_confidence_ensemble: false
  
  # === CONFIDENCE-BASED ENSEMBLE EXPERIMENTS ===
  
  - name: "Milvus_Ensemble_Retail_Conf0.5"
    type: "yolov8_hybrid"
    model_path: "yolov8m.pt"
    use_milvus: true
    similarity_threshold: 0.20
    use_retail_embeddings: true
    retail_model_path: "dolg_retail_model/dolg_retail_best.pth"
    embedding_extractor_type: "retail"
    use_confidence_ensemble: true
    confidence_threshold: 0.5  # Use Milvus when YOLO confidence < 0.5
  
  - name: "Milvus_Ensemble_Retail_Conf0.7"
    type: "yolov8_hybrid"
    model_path: "yolov8m.pt"
    use_milvus: true
    similarity_threshold: 0.20
    use_retail_embeddings: true
    retail_model_path: "dolg_retail_model/dolg_retail_best.pth"
    embedding_extractor_type: "retail"
    use_confidence_ensemble: true
    confidence_threshold: 0.7  # Use Milvus when YOLO confidence < 0.7
  
  - name: "Milvus_Ensemble_Retail_Conf0.8"
    type: "yolov8_hybrid"
    model_path: "yolov8m.pt"
    use_milvus: true
    similarity_threshold: 0.20
    use_retail_embeddings: true
    retail_model_path: "dolg_retail_model/dolg_retail_best.pth"
    embedding_extractor_type: "retail"
    use_confidence_ensemble: true
    confidence_threshold: 0.8  # Use Milvus when YOLO confidence < 0.8
  
  # === ENSEMBLE EMBEDDING EXPERIMENTS (Combine ImageNet + Retail) ===
  
  - name: "Milvus_EnsembleEmbedding_Retail"
    type: "yolov8_hybrid"
    model_path: "yolov8m.pt"
    use_milvus: true
    similarity_threshold: 0.20
    use_retail_embeddings: true
    retail_model_path: "dolg_retail_model/dolg_retail_best.pth"
    embedding_extractor_type: "ensemble"  # Combines retail + ImageNet embeddings
    use_confidence_ensemble: false
